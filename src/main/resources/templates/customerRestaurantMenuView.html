<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${restaurant.name} + ' Menu'">Restaurant Menu</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="body-with-bar">
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm sticky-top">
    <div class="container">
        <a class="navbar-brand" href="/">StreetFoodGo</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item" sec:authorize="!isAuthenticated()">
                    <a class="nav-link" th:href="@{/login}">Login</a>
                </li>
                <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                        Hi, <span sec:authentication="name">User</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li sec:authorize="hasRole('CUSTOMER')">
                            <a class="dropdown-item" th:href="@{/customer/profile}">My Profile</a>
                        </li>
                        <li sec:authorize="hasRole('OWNER')">
                            <a class="dropdown-item" th:href="@{/owner/dashboard}">My Business</a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form th:action="@{/logout}" method="post">
                                <button class="dropdown-item text-danger" type="submit">Logout</button>
                            </form>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-3">
    <div id="cart-notification" class="alert alert-warning alert-dismissible fade show shadow-sm" role="alert" style="display: none;">
        <i class="bi bi-exclamation-circle-fill me-2"></i>
        <span id="cart-notification-msg"></span>
        <button type="button" class="btn-close" onclick="document.getElementById('cart-notification').style.display='none'"></button>
    </div>
</div>

<header class="hero-section mb-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8 text-center text-md-start">
                <h1 class="display-5 fw-bold">
                    <span th:text="${restaurant.name}">Restaurant Name</span>
                    <span th:unless="${restaurant.isOpen()}" class="badge bg-danger fs-6 align-middle ms-2">CLOSED</span>
                    <span th:if="${restaurant.isOpen()}" class="badge bg-success fs-6 align-middle ms-2">OPEN</span>
                </h1>

                <div class="d-inline-flex bg-white rounded-pill p-1 mt-3 shadow-sm text-dark">
                    <div class="btn-group" role="group" aria-label="Service Type">
                        <input type="radio" class="btn-check" name="serviceType" id="stDelivery" value="DELIVERY"
                               autocomplete="off" onchange="updateServiceType('DELIVERY')">
                        <label class="btn btn-outline-danger rounded-pill px-4 border-0 fw-bold" for="stDelivery">
                            <i class="bi bi-bicycle"></i> Delivery
                        </label>

                        <input type="radio" class="btn-check" name="serviceType" id="stPickup" value="PICKUP"
                               autocomplete="off" onchange="updateServiceType('PICKUP')">
                        <label class="btn btn-outline-danger rounded-pill px-4 border-0 fw-bold" for="stPickup">
                            <i class="bi bi-bag"></i> Pickup
                        </label>
                    </div>
                </div>
            </div>

            <div class="col-md-4 text-center mt-4 mt-md-0">
                <img th:src="${restaurant.imageUrl != null && !restaurant.imageUrl.isEmpty() ? restaurant.imageUrl : 'https://t4.ftcdn.net/jpg/02/75/70/03/360_F_275700347_09reCCwb7JBxTKiYQXsyri4riMKaHbj8.jpg'}"
                     class="card-img-top"
                     style="height: 200px; object-fit: cover;"
                     alt="Restaurant Img">
            </div>
        </div>
    </div>
</header>

<div class="category-nav py-3 mb-4">
    <div class="container d-flex gap-2 overflow-auto">
        <button onclick="filterCategory('ALL', this)"
                class="btn rounded-pill bg-dark text-white border px-3 py-2 fw-bold filter-btn active-filter">
            ALL
        </button>

        <button th:each="entry : ${groupedMenuItems}"
                th:data-cat="${entry.key}"
                onclick="filterCategory(this.getAttribute('data-cat'), this)"
                class="btn rounded-pill bg-light text-dark border px-3 py-2 filter-btn">
            <span th:text="${entry.key}">CATEGORY</span>
        </button>
    </div>
</div>

<div class="container">
    <div th:each="entry : ${groupedMenuItems}"
         th:id="${entry.key.name()}"
         th:attr="data-category=${entry.key}"
         class="mb-5 menu-category-section">

        <h3 class="mb-4 text-secondary fw-bold" th:text="${entry.key}">CATEGORY</h3>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <div class="col" th:each="item : ${entry.value}">
                <div class="card menu-card h-100">
                    <img th:src="${item.imageUrl != null && !item.imageUrl.isEmpty() ? item.imageUrl : 'https://media.istockphoto.com/id/1346523346/vector/spoon-and-fork-icon-vector-illustration-design-editable-resizable-eps-10.jpg?s=612x612&w=0&k=20&c=OOAsa1DeluipbQkMVlGsK98eHFjGzz0fMmyyry4pvpA='}"
                         class="card-img-top"
                         style="aspect-ratio: 3/2; object-fit: cover; width: 100%; height: auto;"
                         alt="Menu Item">

                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5 class="card-title fw-bold" th:text="${item.name}">Item Name</h5>
                            <span class="fw-bold text-danger"
                                  th:text="${#numbers.formatDecimal(item.price, 1, 'DEFAULT', 2, 'DEFAULT')} + ' €'">
                                  0.00 €
                            </span>
                        </div>
                        <p class="card-text text-muted small"
                           th:text="${item.description}">
                            Description
                        </p>
                    </div>

                    <div class="card-footer bg-white border-top-0">
                        <button class="btn w-100 add-btn"
                                th:classappend="${restaurant.isOpen()} ? 'btn-primary-custom' : 'btn-secondary'"
                                th:disabled="${!restaurant.isOpen()}"
                                th:id="'btn-add-' + ${item.id}"
                                th:data-id="${item.id}"
                                th:data-name="${item.name}"
                                th:data-price="${item.price}"
                                onclick="addToCart(this.getAttribute('data-id'), this.getAttribute('data-name'), this.getAttribute('data-price'))"
                                th:text="${restaurant.isOpen()} ? 'Add to Order' : 'Closed'">
                            Add to Order
                        </button>

                        <div class="quantity-controls d-none" th:id="'controls-' + ${item.id}">
                            <button class="btn btn-sm btn-outline-danger"
                                    th:data-id="${item.id}"
                                    onclick="updateQuantity(this.getAttribute('data-id'), -1)">
                                <i class="bi bi-dash"></i>
                            </button>
                            <span class="fw-bold mx-3" th:id="'qty-display-' + ${item.id}">1</span>
                            <button class="btn btn-sm btn-outline-success"
                                    th:data-id="${item.id}"
                                    onclick="updateQuantity(this.getAttribute('data-id'), 1)">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="restaurantServiceType" th:value="${restaurant.serviceType}">

<div class="order-total-bar" id="orderTotalBar" th:if="${restaurant.isOpen()}">
    <div class="container d-flex justify-content-between align-items-center">
        <span class="fw-bold fs-5" id="totalPriceDisplay">Total: 0.00 €</span>
        <button class="btn btn-success fw-bold d-flex align-items-center justify-content-center" onclick="goToFinalize()">
            <span class="gradient-text">View Order</span>
            <span id="totalCountBadge" class="badge ms-2">0</span>
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const restaurantId = [[${restaurant.id}]];
    const restaurantName = [[${restaurant.name}]];
    const supportedService = document.getElementById('restaurantServiceType').value || 'DELIVERY';
    /*]]>*/

    let cart = {};
    let currentServiceType = 'DELIVERY'; // Default

    function filterCategory(categoryName, btnElement) {
        const sections = document.querySelectorAll('.menu-category-section');

        sections.forEach(section => {
            const sectionCat = section.getAttribute('data-category');
            if (categoryName === 'ALL' || sectionCat === categoryName) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        });

        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => {
            btn.classList.remove('bg-dark', 'text-white', 'active-filter');
            btn.classList.add('bg-light', 'text-dark');
        });

        if (btnElement) {
            btnElement.classList.remove('bg-light', 'text-dark');
            btnElement.classList.add('bg-dark', 'text-white', 'active-filter');
        }
    }

    function loadCart() {
        const storedCart = localStorage.getItem('streetfoodgo_cart_' + restaurantId);
        if (storedCart) {
            cart = JSON.parse(storedCart);
        }

        const stKey = 'streetfoodgo_service_type_' + restaurantId;
        const storedType = localStorage.getItem(stKey);

        const btnDelivery = document.getElementById('stDelivery');
        const btnPickup = document.getElementById('stPickup');

        if (supportedService === 'PICKUP') {
            currentServiceType = 'PICKUP';
            btnPickup.checked = true;
            btnDelivery.disabled = true;
            btnDelivery.parentElement.title = "This restaurant is Pickup only";
        } else {
            if (storedType) {
                currentServiceType = storedType;
            } else {
                currentServiceType = 'DELIVERY';
            }

            if (currentServiceType === 'DELIVERY') btnDelivery.checked = true;
            else btnPickup.checked = true;
        }

        localStorage.setItem(stKey, currentServiceType);

        updateUI();
    }

    function updateServiceType(type) {
        currentServiceType = type;
        localStorage.setItem('streetfoodgo_service_type_' + restaurantId, type);
    }

    function saveCart() {
        localStorage.setItem('streetfoodgo_cart_' + restaurantId, JSON.stringify(cart));
        localStorage.setItem('streetfoodgo_current_restaurant_name', restaurantName);
    }

    function addToCart(id, name, price) {
        id = String(id);
        if (!cart[id]) {
            cart[id] = { id: id, name: name, price: price, quantity: 1 };
        } else {
            cart[id].quantity++;
        }
        saveCart();
        updateUI();
    }

    function updateQuantity(id, change) {
        id = String(id);
        if (cart[id]) {
            cart[id].quantity += change;
            if (cart[id].quantity <= 0) {
                delete cart[id];
            }
            saveCart();
            updateUI();
        }
    }

    function updateUI() {
        let total = 0;
        let count = 0;

        const addButtons = document.querySelectorAll('.add-btn');

        addButtons.forEach(btn => {
            const id = String(btn.dataset.id);
            const controlsDiv = document.getElementById('controls-' + id);
            const qtyDisplay = document.getElementById('qty-display-' + id);

            if (btn.disabled) return;

            if (cart[id]) {
                btn.classList.add('d-none');
                controlsDiv.classList.remove('d-none');
                controlsDiv.classList.add('d-flex');
                qtyDisplay.innerText = cart[id].quantity;
            } else {
                btn.classList.remove('d-none');
                controlsDiv.classList.add('d-none');
                controlsDiv.classList.remove('d-flex');
            }
        });

        for (let id in cart) {
            total += cart[id].price * cart[id].quantity;
            count += cart[id].quantity;
        }

        document.getElementById('totalPriceDisplay').innerText = 'Total: ' + total.toFixed(2) + ' €';
        document.getElementById('totalCountBadge').innerText = count;
    }

    function goToFinalize() {
        if (Object.keys(cart).length === 0) {
            // ΑΝΤΙΚΑΤΑΣΤΑΣΗ ΤΟΥ alert() ΜΕ UI MESSAGE

            const notifyBox = document.getElementById('cart-notification');
            const notifyMsg = document.getElementById('cart-notification-msg');

            if (notifyBox && notifyMsg) {
                notifyMsg.innerText = "Your cart is empty! Please add items first.";
                notifyBox.style.display = 'block';

                // Scroll στην κορυφή για να δει το μήνυμα ο χρήστης αν είναι χαμηλά
                notifyBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                // Fallback αν δεν βρεθεί το στοιχείο (για σιγουριά)
                console.warn("Notification element not found");
                alert("Your cart is empty! Please add items first.");
            }
            return;
        }
        window.location.href = '/restaurants/' + restaurantId + '/order/finalize';
    }

    window.onload = loadCart;
</script>
</body>
</html>